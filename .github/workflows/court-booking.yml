name: Sport Court Booking

on:
  schedule:
    # Two schedules to cover both GMT and BST, firing ~10min before midnight UK time:
    # GMT period (late Oct - late Mar): 23:50 UTC Fri = 23:50 UK Fri -> 10min to midnight
    # BST period (late Mar - late Oct): 22:50 UTC Fri = 23:50 UK Fri -> 10min to midnight
    # The Python script has its own guard: exits immediately if midnight UK is >20min away.
    - cron: '50 23 * * 5'
    - cron: '50 22 * * 5'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode - bypass Saturday check and midnight wait, run immediately'
        required: false
        type: boolean
        default: false

jobs:
  book-courts:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Validate timing - fail fast before any slow setup
    - name: Validate timing window
      id: check_day
      run: |
        # Use UK timezone (Europe/London) which automatically handles BST/GMT
        UK_DAY_NUM=$(TZ='Europe/London' date +%u)  # 1-7 (Mon-Sun)
        UK_HOUR=$(TZ='Europe/London' date +%H)     # 00-23
        UK_DATE=$(TZ='Europe/London' date '+%Y-%m-%d %H:%M:%S %Z')
        EVENT_NAME="${{ github.event_name }}"
        TEST_MODE="${{ inputs.test_mode }}"

        echo "Event: $EVENT_NAME"
        echo "Test Mode: $TEST_MODE"
        echo "UK Time: $UK_DATE"
        echo "UK Day: $UK_DAY_NUM (5=Friday, 6=Saturday), UK Hour: $UK_HOUR"
        IS_VALID="false"

        # --- Test Mode - bypass all checks ---
        if [ "$TEST_MODE" = "true" ]; then
          echo "*** TEST MODE ENABLED - bypassing timing check ***"
          IS_VALID="true"
        # --- Scheduled Runs ---
        elif [ "$EVENT_NAME" = "schedule" ]; then
          # Cron fires at 22:50 or 23:50 UTC on Friday.
          # Valid window: Friday 22:00-23:59 UK (pre-midnight) or Saturday 00:00-05:59 UK (post-midnight fallback)
          # The Python script's wait_until_midnight_uk() provides the precise timing guard.
          if [ "$UK_DAY_NUM" = "5" ] && [ "$UK_HOUR" -ge 22 ]; then
            IS_VALID="true"
            echo "Valid: Friday $UK_HOUR:xx UK time (pre-midnight window)"
          elif [ "$UK_DAY_NUM" = "6" ] && [ "$UK_HOUR" -le 5 ]; then
            IS_VALID="true"
            echo "Valid: Saturday $UK_HOUR:xx UK time (post-midnight window)"
          else
            echo "Skipping: UK time not in valid Friday-night/Saturday-early window (Day: $UK_DAY_NUM, Hour: $UK_HOUR)"
          fi
        # --- Manual Workflow Dispatch ---
        elif [ "$EVENT_NAME" = "workflow_dispatch" ]; then
          if [ "$UK_DAY_NUM" = "5" ] || [ "$UK_DAY_NUM" = "6" ]; then
            IS_VALID="true"
            echo "Valid manual run: Day $UK_DAY_NUM in UK time"
          else
            echo "Skipping manual run: Not Friday/Saturday in UK time (Day: $UK_DAY_NUM)"
          fi
        fi

        echo "IS_VALID_DAY=$IS_VALID" >> $GITHUB_ENV
        if [ "$IS_VALID" = "true" ]; then
          echo "BOOKING_DAY=Saturday" >> $GITHUB_ENV
          echo "Proceeding with booking setup..."
        else
          echo "Skipping court booking - not in valid timing window."
        fi

    # Only proceed with setup if timing is valid
    - name: Set up Python
      if: env.IS_VALID_DAY == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # Cache pip dependencies
    - name: Cache pip dependencies
      if: env.IS_VALID_DAY == 'true'
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # Cache Playwright browsers
    - name: Cache Playwright browsers
      if: env.IS_VALID_DAY == 'true'
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    # Install system dependencies (required for Playwright)
    - name: Install system dependencies
      if: env.IS_VALID_DAY == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2t64 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
                              libdbus-1-3 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 \
                              libxrandr2 libgbm1 libnspr4 libnss3 libxss1 libxtst6 libgl1

    # Install Python dependencies
    - name: Install Python dependencies
      if: env.IS_VALID_DAY == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # Install Chromium browser
    - name: Install Chromium browser
      if: env.IS_VALID_DAY == 'true'
      run: playwright install chromium

    # No random delay - speed is critical for midnight booking window

    - name: Run booking script
      if: env.IS_VALID_DAY == 'true'
      id: booking
      env:
        LTA_USERNAME: ${{ secrets.LTA_USERNAME }}
        LTA_PASSWORD: ${{ secrets.LTA_PASSWORD }}
        LTA_USERNAME2: ${{ secrets.LTA_USERNAME2 }}
        LTA_PASSWORD2: ${{ secrets.LTA_PASSWORD2 }}
        TEST_MODE: ${{ inputs.test_mode }}
        TRIGGER_EVENT: ${{ github.event_name }}
      run: python court_booker.py

    - name: Read booking results
      if: env.IS_VALID_DAY == 'true'
      id: results
      run: |
        if [ -f booking_results.txt ]; then
          RESULTS=$(cat booking_results.txt)
          echo "BOOKING_RESULTS<<EOF" >> $GITHUB_ENV
          echo "$RESULTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "BOOKING_RESULTS=No booking results file found" >> $GITHUB_ENV
        fi

    - name: Upload screenshots
      if: env.IS_VALID_DAY == 'true' && hashFiles('*.png') != ''
      uses: actions/upload-artifact@v4
      with:
        name: booking-screenshots-${{ github.run_id }}
        path: |
          *.png
        retention-days: 5
        compression-level: 9
        overwrite: true

    - name: Send email notification
      if: env.IS_VALID_DAY == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Court Booking Results - ${{ env.BOOKING_DAY }}"
        body: |
          Hi team,

          I've just attempted to book the courts for you. See below for the details:

          Booking Details:
          ----------------
          ${{ env.BOOKING_RESULTS }}

          Remember: If you need to cancel or change any bookings, you'll need to do that through the club website.

          Best regards,
          Off-shore Team
        to: ${{ secrets.NOTIFICATION_EMAILS }}
        from: Off-shore Team
