name: Tennis Court Booking

on:
  schedule:
    # Run at 7:00 AM UTC on Thursday and Saturday
    - cron: '0 7 * * 4,6'
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  book-courts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright python-dotenv
          playwright install chromium
          
      - name: Set booking configuration
        id: config
        run: |
          if [[ $(date +%u) == 4 ]]; then
            echo "BOOKING_TIME1=19:00" >> $GITHUB_ENV
            echo "BOOKING_TIME2=20:00" >> $GITHUB_ENV
            echo "DAY_TYPE=Thursday" >> $GITHUB_ENV
          else
            echo "BOOKING_TIME1=11:00" >> $GITHUB_ENV
            echo "BOOKING_TIME2=12:00" >> $GITHUB_ENV
            echo "DAY_TYPE=Saturday" >> $GITHUB_ENV
          fi
          
      - name: Create .env file
        run: |
          echo "LTA_USERNAME=${{ secrets.LTA_USERNAME }}" >> .env
          echo "LTA_PASSWORD=${{ secrets.LTA_PASSWORD }}" >> .env
          echo "LTA_USERNAME2=${{ secrets.LTA_USERNAME2 }}" >> .env
          echo "LTA_PASSWORD2=${{ secrets.LTA_PASSWORD2 }}" >> .env
          
      - name: Run booking script
        id: booking
        run: |
          # Run the script and capture its output
          OUTPUT=$(python court_booker.py)
          echo "script_output<<EOF" >> $GITHUB_ENV
          echo "$OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          BOOKING_TIME1: ${{ env.BOOKING_TIME1 }}
          BOOKING_TIME2: ${{ env.BOOKING_TIME2 }}

      - name: Send email notification
        if: always()  # Send email whether the script succeeds or fails
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Tennis Court Booking Results - ${{ env.DAY_TYPE }}"
          body: |
            Tennis Court Booking Results for ${{ env.DAY_TYPE }}
            
            Booking Times:
            - First Booking: ${{ env.BOOKING_TIME1 }}
            - Second Booking: ${{ env.BOOKING_TIME2 }}
            
            Results:
            ${{ env.script_output }}
            
            For detailed logs, please check the GitHub Actions run at:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.NOTIFICATION_EMAILS }}
          from: Tennis Court Booking System 