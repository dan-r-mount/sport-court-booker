name: Sport Court Booking

on:
  schedule:
    # Two schedules to handle BST/GMT for midnight UK time on Saturday:
    # - During BST (late March - late October): UK is UTC+1, so midnight UK = 23:00 UTC Friday
    # - During GMT (late October - late March): UK is UTC+0, so midnight UK = 00:00 UTC Saturday
    - cron: '0 23 * * 5'  # 23:00 UTC Friday (midnight Saturday UK during BST)
    - cron: '0 0 * * 6'   # 00:00 UTC Saturday (midnight Saturday UK during GMT)
  workflow_dispatch:  # Allows manual triggering

jobs:
  book-courts:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # CHECK DAY FIRST - fail fast before any slow setup
    - name: Check if correct day for booking
      id: check_day
      run: |
        # Use UK timezone (Europe/London) which automatically handles BST/GMT
        UK_DAY_NUM=$(TZ='Europe/London' date +%u)  # 1-7 (Mon-Sun)
        UK_HOUR=$(TZ='Europe/London' date +%H)     # 00-23
        UK_DATE=$(TZ='Europe/London' date '+%Y-%m-%d %H:%M:%S %Z')
        EVENT_NAME="${{ github.event_name }}"

        echo "Event: $EVENT_NAME"
        echo "UK Time: $UK_DATE"
        echo "UK Day Num: $UK_DAY_NUM (6=Saturday), UK Hour: $UK_HOUR"
        IS_VALID_FOR_RUN="false"

        # --- Scheduled Runs ---
        if [ "$EVENT_NAME" = "schedule" ]; then
          # Check if it's Saturday in UK time (day 6) and within the first hour
          if [ "$UK_DAY_NUM" = "6" ] && [ "$UK_HOUR" = "00" ]; then
            TARGET_DAY_NAME="Saturday"
            TARGET_TIME1="11:00"
            TARGET_TIME2="12:00"
            IS_VALID_FOR_RUN="true"
            echo "Valid scheduled run: It's Saturday $UK_HOUR:xx UK time"
          else
            echo "Skipping: UK time is not Saturday 00:xx (UK Day: $UK_DAY_NUM, Hour: $UK_HOUR)"
          fi
        # --- Manual Workflow Dispatch ---
        elif [ "$EVENT_NAME" = "workflow_dispatch" ]; then
          if [ "$UK_DAY_NUM" = "6" ]; then
            TARGET_DAY_NAME="Saturday"
            TARGET_TIME1="11:00"
            TARGET_TIME2="12:00"
            IS_VALID_FOR_RUN="true"
            echo "Valid manual run: It's Saturday in UK time"
          else
            echo "Skipping manual run: Not Saturday in UK time (UK Day: $UK_DAY_NUM)"
          fi
        fi

        if [ "$IS_VALID_FOR_RUN" = "true" ]; then
          echo "IS_VALID_DAY=true" >> $GITHUB_ENV
          echo "BOOKING_DAY=$TARGET_DAY_NAME" >> $GITHUB_ENV
          echo "BOOKING_TIME1=$TARGET_TIME1" >> $GITHUB_ENV
          echo "BOOKING_TIME2=$TARGET_TIME2" >> $GITHUB_ENV
          echo "Setting BOOKING_DAY=$TARGET_DAY_NAME, TIME1=$TARGET_TIME1, TIME2=$TARGET_TIME2"
        else
          echo "IS_VALID_DAY=false" >> $GITHUB_ENV
          echo "Skipping court booking - not the correct time in UK timezone."
        fi

    # Only proceed with setup if it's a valid day
    - name: Set up Python
      if: env.IS_VALID_DAY == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # Cache pip dependencies
    - name: Cache pip dependencies
      if: env.IS_VALID_DAY == 'true'
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # Cache Playwright browsers
    - name: Cache Playwright browsers
      if: env.IS_VALID_DAY == 'true'
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    # Install system dependencies (required for Playwright)
    - name: Install system dependencies
      if: env.IS_VALID_DAY == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2t64 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
                              libdbus-1-3 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 \
                              libxrandr2 libgbm1 libnspr4 libnss3 libxss1 libxtst6 libgl1

    # Install Python dependencies
    - name: Install Python dependencies
      if: env.IS_VALID_DAY == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # Install Chromium browser
    - name: Install Chromium browser
      if: env.IS_VALID_DAY == 'true'
      run: playwright install chromium

    # Add small random delay to appear natural (5-45 seconds)
    - name: Add random delay
      if: env.IS_VALID_DAY == 'true' && github.event_name == 'schedule'
      run: |
        RANDOM_DELAY=$(( $RANDOM % 41 + 5 ))  # 5-45 seconds
        echo "Adding random delay of $RANDOM_DELAY seconds to appear natural"
        echo "Current UK time: $(TZ='Europe/London' date '+%H:%M:%S')"
        sleep $RANDOM_DELAY
        echo "Proceeding with booking at UK time: $(TZ='Europe/London' date '+%H:%M:%S')"

    - name: Run booking script
      if: env.IS_VALID_DAY == 'true'
      id: booking
      env:
        LTA_USERNAME: ${{ secrets.LTA_USERNAME }}
        LTA_PASSWORD: ${{ secrets.LTA_PASSWORD }}
        LTA_USERNAME2: ${{ secrets.LTA_USERNAME2 }}
        LTA_PASSWORD2: ${{ secrets.LTA_PASSWORD2 }}
      run: python court_booker.py

    - name: Upload screenshots and read results
      if: env.IS_VALID_DAY == 'true'
      id: results
      run: |
        if [ -f booking_results.txt ]; then
          RESULTS=$(cat booking_results.txt)
          echo "BOOKING_RESULTS<<EOF" >> $GITHUB_ENV
          echo "$RESULTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "BOOKING_RESULTS=No booking results file found" >> $GITHUB_ENV
        fi

    - name: Upload screenshots
      if: env.IS_VALID_DAY == 'true' && hashFiles('*.png') != ''
      uses: actions/upload-artifact@v4
      with:
        name: booking-screenshots-${{ github.run_id }}
        path: |
          *.png
        retention-days: 5
        compression-level: 9
        overwrite: true

    - name: Send email notification
      if: env.IS_VALID_DAY == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Court Booking Results - ${{ env.BOOKING_DAY }}"
        body: |
          Hi team,

          I've just attempted to book the courts for you. See below for the details:

          Booking Details:
          ----------------
          ${{ env.BOOKING_RESULTS }}

          Remember: If you need to cancel or change any bookings, you'll need to do that through the club website.

          Best regards,
          Off-shore Team
        to: ${{ secrets.NOTIFICATION_EMAILS }}
        from: Off-shore Team
